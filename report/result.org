#+TITLE: NASM 오버헤드 스쿼트 평가 시스템 결과 보고서
#+AUTHOR: Kim Daewon
#+DATE: {{{time(%Y-%m-%d)}}}
#+PROPERTY: header-args:jupyter-python :session result :kernel nasm-assessment
#+OPTIONS: toc:2 num:t author:t date:t
#+LATEX_CLASS: article
#+LATEX_CLASS_OPTIONS: [a4paper,11pt]
#+LATEX_HEADER: \usepackage{kotex}
#+LATEX_HEADER: \usepackage{graphicx}
#+LATEX_HEADER: \usepackage{booktabs}
#+LATEX_HEADER: \usepackage{float}
#+LATEX_HEADER: \usepackage[margin=2.5cm]{geometry}
#+LATEX_HEADER: \usepackage{xcolor}
#+LATEX_HEADER: \usepackage[font=small,labelfont=bf,skip=5pt]{caption}
#+LATEX_HEADER: \definecolor{highlight}{RGB}{52, 152, 219}

* 요약

** 핵심 요약

노이즈가 심한 3D 모션 캡처 데이터에서 @@latex:\textbf{통합 최적화 기법}@@을 적용하여, 해부학적 일관성을 유지하면서 @@latex:\textbf{평균 39배의 노이즈 감소}@@를 달성하고 신뢰할 수 있는 NASM 스쿼트 평가 결과를 도출했습니다.

** 핵심 성과

1. *노이즈 감소*: 가속도 분산 기준 7~14배 개선 (고노이즈 데이터 최대 105배)
2. *해부학적 정확성*: 뼈 길이 표준편차 0.15mm 이하로 시간에 따른 변동 최소화
3. *적응형 처리*: 일반/고노이즈 데이터에 대한 프리셋 자동 적용으로 5명 피험자 전원 분석 성공

* 프로젝트 개요

** 배경 및 목적

NASM(National Academy of Sports Medicine) 오버헤드 스쿼트 평가는 근골격계 불균형을 식별하는 표준 기능적 움직임 평가입니다. 본 프로젝트는 3D 모션 캡처 데이터를 분석하여 다음 세 가지 핵심 지표를 자동으로 측정합니다:

| 평가 항목     | 관찰 시점 | 측정 내용                          |
|--------------+----------+-----------------------------------|
| *무릎 내전*   | 전방     | 스쿼트 시 무릎이 안쪽으로 모이는 정도 |
| *허리 아치*   | 측면     | 요추부 과전만 또는 평평해짐          |
| *상체 기울기* | 측면     | 몸통이 앞으로 숙여지는 정도          |

** 범위

- *데이터*: 5명 피험자, 각 피험자당 5회 스쿼트 사이클
- *관절점*: 15개 (머리, 몸통, 허리, 어깨, 팔꿈치, 손목, 고관절, 무릎, 발목 × 좌/우)
- *샘플링*: 30fps, 약 250~450 프레임/피험자

* 수행 내용

** 주요 단계 요약

#+ATTR_LATEX: :environment tabular :align |c|l|l|
| 단계 | 작업                  | 목적                         |
|------+-----------------------+------------------------------|
|    1 | 스파이크 감지 및 제거 | 센서 오류로 인한 이상치 처리 |
|    2 | 저역통과 필터링       | 고주파 노이즈 제거           |
|    3 | 통합 최적화           | 다중 제약조건 동시 충족      |
|    4 | 평가 지표 계산        | 무릎 내전, 자세 각도 산출    |
|    5 | 시각화 생성           | 그래프 및 애니메이션 출력    |

** 처리 파이프라인

#+BEGIN_SRC text
원본 데이터 ─→ [MAD 스파이크 감지] ─→ [선형 보간] ─→ [Butterworth 필터]
                                                              │
                                                              ▼
평가 결과 ←── [지표 계산] ←── [통합 최적화: 9개 손실함수] ←──┘
#+END_SRC

** 적용 프리셋

| 프리셋       | 저역통과 Cutoff | 적용 대상       |
|--------------+-----------------+-----------------|
| =default=    | 3.0 Hz          | Subject 1, 2, 3 |
| =high-noise= | 2.0 Hz          | Subject 4, 5    |

* 결과

** 필터링 성능 비교 (Before/After)

| 피험자 | RMSE (mm) | 뼈 길이 σ (mm) | 가속도 개선   | 최적화 반복 |
|--------+-----------+----------------+---------------+-------------|
|      1 |      25.9 |           0.06 | 13.6x         |       4,049 |
|      2 |      16.7 |           0.11 | 12.2x         |       4,139 |
|      3 |      15.2 |           0.15 | 7.3x          |       4,089 |
|      4 |      51.4 |           0.30 | *57.3x*       |       3,839 |
|      5 |      29.9 |           0.11 | *105.7x* [†]  |       3,170 |
|--------+-----------+----------------+---------------+-------------|
| *평균* |    *27.8* |         *0.15* | *39.2x*       |      *3,857* |

[†] Subject 5는 원본 데이터 끝 53프레임에 NaN이 포함되어 유효 프레임(365/418)만으로 계산

- *RMSE*: 원본과 필터링 결과의 평균 거리 (원본 형태 유지 정도)
- *뼈 길이 σ*: 뼈 길이의 시간적 변동 (낮을수록 해부학적으로 정확)
- *가속도 개선*: 원본 대비 필터링 후 가속도 분산 감소 비율

** 무릎 내전 평가 결과

| 피험자 | 왼쪽 최대 | 왼쪽 최소 | 오른쪽 최대 | 오른쪽 최소 | 판정               |
|--------+-----------+-----------+-------------+-------------+--------------------|
|      1 | 1.9°      | -8.7°     | 3.7°        | -4.7°       | 경미한 우측 내전   |
|      2 | 0.4°      | -14.9°    | 0.7°        | -13.0°      | 정상 (외전 우세)   |
|      3 | 2.5°      | -4.6°     | 1.8°        | -2.4°       | 정상               |
|      4 | 5.5°      | -7.7°     | *9.5°*      | -6.9°       | *우측 내전 주의*   |
|      5 | *6.4°*    | -2.5°     | 1.7°        | -7.3°       | *좌측 내전 주의*   |

- *양수(+)*: 무릎이 안쪽으로 (내전, valgus) - 5° 이상 시 주의
- *음수(-)*: 무릎이 바깥쪽으로 (외전, varus)

** 자세 평가 결과

| 피험자 | 허리 아치 최대 | 상체 기울기 최대 | 판정                   |
|--------+----------------+------------------+------------------------|
|      1 | 64.9°          | -17.7°           | 정상 범위              |
|      2 | 85.7°          | -15.5°           | 정상 범위              |
|      3 | 58.1°          | -16.5°           | 정상 범위              |
|      4 | *119.9°*       | *-43.0°*         | *과도한 전방 기울기*   |
|      5 | 59.0°          | *-27.5°*         | *전방 기울기 주의*     |

- *상체 기울기 음수*: 앞으로 숙여짐 (20° 초과 시 주의)
- *허리 아치*: 상/하부 척추 각도 차이

** 시각화 결과

*** 원본 데이터 노이즈 비교

아래 그래프는 필터링 전 원본 데이터의 노이즈 수준을 비교합니다. Subject 4(고노이즈)는 Subject 3(일반)에 비해 가속도 기준 약 8배 높은 노이즈를 보입니다.

#+BEGIN_SRC jupyter-python :exports none
import numpy as np
import matplotlib.pyplot as plt
import sys
sys.path.insert(0, '..')

plt.rcParams['font.family'] = 'AppleGothic'
plt.rcParams['axes.unicode_minus'] = False

from src_old.data_loader import load_subject_data, dataframe_to_skeleton

# Load data
df3 = load_subject_data('../data/3.xlsx')
df4 = load_subject_data('../data/4.xlsx')
skeleton3 = dataframe_to_skeleton(df3, 3)
skeleton4 = dataframe_to_skeleton(df4, 4)

# Build positions array
def skeleton_to_positions(skeleton):
    joint_names = ['head', 'torso', 'waist', 'l_shoulder', 'l_elbow', 'l_wrist',
                   'r_shoulder', 'r_elbow', 'r_wrist', 'l_hip', 'l_knee', 'l_ankle',
                   'r_hip', 'r_knee', 'r_ankle']
    n_frames = skeleton.n_frames
    positions = np.zeros((n_frames, len(joint_names), 3))
    for i, name in enumerate(joint_names):
        positions[:, i, :] = skeleton.joints[name].as_array()
    return positions

pos3 = skeleton_to_positions(skeleton3)
pos4 = skeleton_to_positions(skeleton4)

# Compute acceleration
def compute_acceleration(positions):
    accel = positions[2:] - 2 * positions[1:-1] + positions[:-2]
    return np.linalg.norm(accel, axis=2).mean(axis=1)

accel3 = compute_acceleration(pos3)
accel4 = compute_acceleration(pos4)

# Create figure
fig, axes = plt.subplots(2, 2, figsize=(12, 8))
l_knee_idx = 10

ax = axes[0, 0]
ax.plot(pos3[:, l_knee_idx, 1], 'b-', linewidth=0.8)
ax.set_title('Subject 3 (일반) - 왼쪽 무릎 Y좌표', fontsize=11)
ax.set_xlabel('프레임')
ax.set_ylabel('위치 (mm)')
ax.grid(True, alpha=0.3)

ax = axes[0, 1]
ax.plot(pos4[:, l_knee_idx, 1], 'r-', linewidth=0.8)
ax.set_title('Subject 4 (고노이즈) - 왼쪽 무릎 Y좌표', fontsize=11)
ax.set_xlabel('프레임')
ax.set_ylabel('위치 (mm)')
ax.grid(True, alpha=0.3)

ax = axes[1, 0]
ax.plot(accel3, 'b-', linewidth=0.8, label='Subject 3')
ax.plot(accel4, 'r-', linewidth=0.8, alpha=0.7, label='Subject 4')
ax.set_title('가속도 크기 비교 (전체 관절 평균)', fontsize=11)
ax.set_xlabel('프레임')
ax.set_ylabel('가속도 (mm/frame²)')
ax.legend()
ax.grid(True, alpha=0.3)
ax.set_ylim(0, 400)

ax = axes[1, 1]
bp = ax.boxplot([accel3, accel4], tick_labels=['Subject 3', 'Subject 4'], patch_artist=True)
bp['boxes'][0].set_facecolor('lightblue')
bp['boxes'][1].set_facecolor('lightcoral')
ax.set_title('가속도 분포 비교', fontsize=11)
ax.set_ylabel('가속도 (mm/frame²)')
ax.grid(True, alpha=0.3, axis='y')

plt.tight_layout()
plt.savefig('subject3_vs_4_noise.png', dpi=150, bbox_inches='tight')
plt.close()
#+END_SRC

#+CAPTION: Subject 3 vs Subject 4 - 원본 데이터 노이즈 비교
#+ATTR_LATEX: :width 0.95\textwidth :placement [H]
[[./subject3_vs_4_noise.png]]

*** 필터링 후 데이터 비교

전처리 및 통합 최적화 적용 후, 두 피험자의 가속도가 유사한 수준(~2.5 mm/frame²)으로 수렴하여 노이즈가 효과적으로 제거되었음을 확인할 수 있습니다.

#+BEGIN_SRC jupyter-python :exports none
# Load filtered data
filtered3 = pd.read_csv('../output/final/subject_3/filtered.csv')
filtered4 = pd.read_csv('../output/final/subject_4/filtered.csv')

def csv_to_positions(df):
    joint_names = ['head', 'torso', 'waist', 'l_shoulder', 'l_elbow', 'l_wrist',
                   'r_shoulder', 'r_elbow', 'r_wrist', 'l_hip', 'l_knee', 'l_ankle',
                   'r_hip', 'r_knee', 'r_ankle']
    n_frames = len(df)
    positions = np.zeros((n_frames, len(joint_names), 3))
    for i, name in enumerate(joint_names):
        positions[:, i, 0] = df[f'{name}_x'].values
        positions[:, i, 1] = df[f'{name}_y'].values
        positions[:, i, 2] = df[f'{name}_z'].values
    return positions

filt_pos3 = csv_to_positions(filtered3)
filt_pos4 = csv_to_positions(filtered4)
filt_accel3 = compute_acceleration(filt_pos3)
filt_accel4 = compute_acceleration(filt_pos4)

fig, axes = plt.subplots(2, 2, figsize=(12, 8))
l_knee_idx = 10

ax = axes[0, 0]
ax.plot(filt_pos3[:, l_knee_idx, 1], 'b-', linewidth=0.8)
ax.set_title('Subject 3 (필터링 후) - 왼쪽 무릎 Y좌표', fontsize=11)
ax.set_xlabel('프레임')
ax.set_ylabel('위치 (mm)')
ax.grid(True, alpha=0.3)

ax = axes[0, 1]
ax.plot(filt_pos4[:, l_knee_idx, 1], 'r-', linewidth=0.8)
ax.set_title('Subject 4 (필터링 후) - 왼쪽 무릎 Y좌표', fontsize=11)
ax.set_xlabel('프레임')
ax.set_ylabel('위치 (mm)')
ax.grid(True, alpha=0.3)

ax = axes[1, 0]
ax.plot(filt_accel3, 'b-', linewidth=0.8, label='Subject 3')
ax.plot(filt_accel4, 'r-', linewidth=0.8, alpha=0.7, label='Subject 4')
ax.set_title('가속도 크기 비교 - 필터링 후 (전체 관절 평균)', fontsize=11)
ax.set_xlabel('프레임')
ax.set_ylabel('가속도 (mm/frame²)')
ax.legend()
ax.grid(True, alpha=0.3)
ax.set_ylim(0, 15)

ax = axes[1, 1]
bp = ax.boxplot([filt_accel3, filt_accel4], tick_labels=['Subject 3', 'Subject 4'], patch_artist=True)
bp['boxes'][0].set_facecolor('lightblue')
bp['boxes'][1].set_facecolor('lightcoral')
ax.set_title('가속도 분포 비교 - 필터링 후', fontsize=11)
ax.set_ylabel('가속도 (mm/frame²)')
ax.grid(True, alpha=0.3, axis='y')

plt.tight_layout()
plt.savefig('subject3_vs_4_filtered.png', dpi=150, bbox_inches='tight')
plt.close()
#+END_SRC

#+CAPTION: Subject 3 vs Subject 4 - 필터링 후 데이터 비교
#+ATTR_LATEX: :width 0.95\textwidth :placement [H]
[[./subject3_vs_4_filtered.png]]

#+LATEX: \clearpage
*** Subject 3 - 필터링 후 평가 결과 (일반 데이터)

#+CAPTION: Subject 3 - 무릎 내전 분석 (전방 관찰)
#+ATTR_LATEX: :width 0.85\textwidth :placement [H]
[[../output/final/subject_3/knee_valgus.png]]

#+CAPTION: Subject 3 - 자세 분석 (측면 관찰)
#+ATTR_LATEX: :width 0.85\textwidth :placement [H]
[[../output/final/subject_3/posture.png]]

#+LATEX: \clearpage
*** Subject 4 - 필터링 후 평가 결과 (고노이즈 데이터)

#+CAPTION: Subject 4 - 무릎 내전 분석 (전방 관찰)
#+ATTR_LATEX: :width 0.85\textwidth :placement [H]
[[../output/final/subject_4/knee_valgus.png]]

#+CAPTION: Subject 4 - 자세 분석 (측면 관찰)
#+ATTR_LATEX: :width 0.85\textwidth :placement [H]
[[../output/final/subject_4/posture.png]]

#+LATEX: \clearpage

* 결론 및 제언

** 성과 요약

1. *통합 최적화 프레임워크*: 데이터 충실도, 뼈 길이, 관절 가동범위, 가속도, 저크, 각속도, 떨림, 방향 일관성, 척추 정렬 등 9개 제약조건을 손실함수로 표현하고 경사하강법으로 동시 최적화
2. *노이즈 처리 성공*: 고노이즈 데이터(Subject 4, 5)에서도 해부학적으로 유효한 결과 도출 (가속도 기준 최대 105배 개선)
3. *해부학적 일관성*: 뼈 길이 변동을 0.15mm 이하로 유지하여 비현실적 변형 방지
4. *정량적 평가*: 무릎 내전, 허리 아치, 상체 기울기를 객관적 수치로 제공

** 한계점

| 한계                 | 설명                                           |
|----------------------+------------------------------------------------|
| 2D 평가 의존         | 전방/측면 관찰만 사용, 3D 각도 계산 미적용     |
| 고정 임계값          | 5° 내전 등 판정 기준이 개인차를 반영하지 못함  |
| 실시간 처리 미지원   | 배치 처리 전용, 실시간 피드백 불가             |

** 향후 발전 방향

1. *3D 각도 계산*: hip-knee-ankle 평면의 실제 3D 각도 측정으로 정확도 향상
2. *개인화 기준선*: 피험자별 정상 범위 학습을 통한 맞춤형 평가
3. *실시간 처리*: 스트리밍 데이터 지원으로 즉각적 피드백 제공
4. *추가 평가 항목*: 발 외전(foot flattening), 팔 전방 이동(arms fall forward) 등 확장
5. *보고서 자동 생성*: 평가 결과 기반 교정 운동 자동 추천

* 부록

** 출력 파일 구조

#+BEGIN_SRC text
output/final/
├── subject_1/
│   ├── assessment.csv         # 필터링 좌표 + 평가 각도
│   ├── knee_valgus.png        # 무릎 내전 그래프
│   ├── posture.png            # 자세 평가 그래프
│   └── skeleton_comparison.gif # 원본/필터링 비교 애니메이션
├── subject_2/
└── ...

output/refined_visualization/
├── 1_skeleton_comparison.gif  # 정제된 스켈레톤 애니메이션
├── 2_skeleton_comparison.gif
├── 3_skeleton_comparison.gif
├── 4_skeleton_comparison.gif
└── 5_skeleton_comparison.gif
#+END_SRC

*정제된 애니메이션*: =output/refined_visualization/= 폴더에는 원본 스켈레톤과 필터링된 스켈레톤을 나란히 비교할 수 있는 애니메이션이 피험자별로 저장되어 있습니다.

** 실행 명령어

#+BEGIN_SRC bash
# 전체 분석 실행
uv run python -m src.main --subjects 1 2 3 4 5 --output-dir output/final

# 고노이즈 데이터 전용
uv run python -m src.main --subjects 4 5 --preset high-noise --output-dir output/final
#+END_SRC
